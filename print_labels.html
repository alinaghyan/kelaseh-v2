<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>چاپ لیبل پرونده</title>
    <style>
        @font-face {
            font-family: 'Vazirmatn';
            src: url('assets/fonts/Vazirmatn.woff2') format('woff2');
        }
        body {
            font-family: 'Vazirmatn', Tahoma, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #eee;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .no-print {
            padding: 20px;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
            text-align: center;
        }
        .print-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Center vertically if single or small content */
            padding: 10mm;
            background: #eee;
        }
        .label-box {
            width: 100%;
            max-width: 180mm; /* Fits A4, scales down for A5 */
            border: 2px solid #000;
            padding: 20px;
            background: #fff;
            page-break-inside: avoid;
            position: relative;
            box-sizing: border-box;
            margin: 10px 0;
        }
        .label-header {
            text-align: center;
            font-weight: bold;
            font-size: 28px;
            margin-bottom: 15px;
            border-bottom: 1px solid #000;
            padding-bottom: 10px;
            direction: ltr;
        }
        .label-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 18px;
            border-bottom: 1px dotted #ccc;
            padding-bottom: 5px;
        }
        .label-row:last-child {
            border-bottom: none;
        }
        .label-footer {
            font-size: 14px;
            color: #444;
            margin-top: 15px;
            border-top: 1px solid #000;
            padding-top: 5px;
            display: flex;
            justify-content: space-between;
        }
        .label-history {
            font-size: 12px;
            color: #555;
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px dashed #ccc;
        }
        .label-history-item {
            display: inline-block;
            direction: ltr;
            unicode-bidi: embed;
        }
        /* Single label scaling */
        .single-label .label-box {
            padding: 30px;
            border-width: 3px;
        }
        .single-label .label-header {
            font-size: 36px;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        .single-label .label-row {
            font-size: 22px;
            margin-bottom: 15px;
            padding-bottom: 8px;
        }
        .single-label .label-footer {
            font-size: 18px;
            margin-top: 25px;
        }

        @media print {
            @page {
                margin: 0;
            }
            body { 
                background: #fff; 
                display: block;
                width: 100%;
                height: 100%;
            }
            .no-print { display: none !important; }
            .print-container { 
                padding: 0; 
                margin: 0;
                background: #fff;
                display: flex;
                height: 100vh;
                width: 100vw;
                justify-content: center;
                align-items: center;
                overflow: hidden; /* Prevent spillover to second page */
            }
            /* If multiple labels, don't force full height centering for all */
            .print-container.multiple-labels {
                display: block;
                height: auto;
                width: auto;
                padding: 10mm;
            }
            .label-box {
                margin: 0;
                border-width: 2px;
                box-shadow: none;
                page-break-inside: avoid;
            }
            .multiple-labels .label-box {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>

<div class="no-print" style="text-align: center; margin-bottom: 20px;">
    <button onclick="window.print()" style="padding: 10px 20px; font-size: 16px; cursor: pointer;">چاپ / ذخیره PDF</button>
</div>

<div class="print-container" id="labelsContainer">
    <!-- Labels will be injected here -->
</div>

<script>
    function toPersianDigits(str) {
        if (!str) return '';
        const map = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
        return String(str).replace(/[0-9]/g, function (w) {
            return map[+w];
        });
    }

    const queue = localStorage.getItem('print_queue');
    if (queue) {
        const items = JSON.parse(queue);
        const container = document.getElementById('labelsContainer');
        
        if (items.length > 1) {
            container.classList.add('multiple-labels');
        } else if (items.length === 1) {
            container.classList.add('single-label');
        }
        
        items.forEach(item => {
            const code = toPersianDigits(item.new_case_code || item.full_code || item.code);
            const pName = item.plaintiff_name || '-';
            const dName = item.defendant_name || '-';
            const date = toPersianDigits(item.created_at_jalali || '-');
            const city = toPersianDigits((item.city_name ? 'اداره ' + item.city_name : 'اداره ...') + (item.branch_name ? ' - ' + item.branch_name : ''));

            let manualText = '';
            if (Number(item.is_manual) && Number(item.is_manual_branch)) {
                manualText = ' - شعبه و تاریخ دستی';
            } else if (Number(item.is_manual)) {
                manualText = ' - تاریخ دستی';
            } else if (Number(item.is_manual_branch)) {
                manualText = ' - شعبه دستی';
            }

            const pHist = Array.isArray(item.history_plaintiff) ? item.history_plaintiff : [];
            const dHist = Array.isArray(item.history_defendant) ? item.history_defendant : [];

            let histHtml = '';
            if (pHist.length > 0 || dHist.length > 0) {
                const formatDate = (dt) => dt ? dt.split(' ')[0] : '';
                histHtml = `
                    <div class="label-history">
                        ${pHist.length > 0 ? `<div>سوابق خواهان: ${pHist.map(h => `<span class="label-history-item">${toPersianDigits(h.code)}</span> (${toPersianDigits(formatDate(h.created_at_jalali))})`).join('، ')}</div>` : ''}
                        ${dHist.length > 0 ? `<div>سوابق خوانده: ${dHist.map(h => `<span class="label-history-item">${toPersianDigits(h.code)}</span> (${toPersianDigits(formatDate(h.created_at_jalali))})`).join('، ')}</div>` : ''}
                    </div>
                `;
            }

            const div = document.createElement('div');
            div.className = 'label-box';
            div.innerHTML = `
                <div class="label-header">${code}</div>
                <div class="label-row">
                    <span>خواهان: ${pName}</span>
                </div>
                <div class="label-row">
                    <span>خوانده: ${dName}</span>
                </div>
                <div class="label-footer">
                    <span>تاریخ ثبت: ${date}${manualText}</span>
                    <span>${city}</span>
                </div>
                ${histHtml}
            `;
            container.appendChild(div);
        });
    } else {
        document.getElementById('labelsContainer').innerHTML = '<div style="text-align:center; padding: 50px;">موردی برای چاپ یافت نشد.</div>';
    }
</script>

</body>
</html>
